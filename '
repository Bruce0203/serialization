use crate::CompositeEncoder;

use super::{
    edge::Edge,
    flatten::Flatten,
    pad::ConstifyPadding,
    segment::{SegmentCodec, SegmentEncoder, SegmentWalker},
    sort::Sorted,
};

pub trait Mesh<C> {
    type Output;
}

impl<T, C> Mesh<C> for T
where
    C: CompositeEncoder,
    T: Edge<Second: Sorted<Output: ConstifyPadding<Output: Flatten<T>>>>,
{
    type Output = <<<<T as Edge>::Second as Sorted>::Output as ConstifyPadding>::Output as Flatten<T>>::Output;
}

pub fn encode<T, C>(src: &T, codec: &mut C) -> Result<(), C::Error>
where
    T: Edge,
    C: CompositeEncoder,
{
    walk_segment::<T, C, SegmentEncoder>(src, codec)?;
    Ok(())
}

//TODO try remove inline never
#[inline(never)]
pub fn walk_segment<T, C, H>(src: &T, codec: &mut C) -> Result<(), H::Error>
where
    H: SegmentCodec<C>,
    C: CompositeEncoder,
    T: Mesh<C, Output: SegmentWalker<T, C, H>>,
{
    <T as Mesh<C>>::Output::walk(src, codec, None)
}
